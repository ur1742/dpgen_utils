<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DPGEN Web Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f6f9;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 25px;
        }
        .section {
            margin: 25px 0;
            padding: 18px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        h2 {
            margin-top: 0;
            color: #3498db;
            font-size: 1.3em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
        }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        button {
            padding: 10px 14px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        button:hover {
            background-color: #2980b9;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            color: white;
            text-decoration: none;
        }
        .btn-success {
            background-color: #27ae60;
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .btn-success:hover {
            background-color: #219653;
            color: white;
            text-decoration: none;
        }
        .btn-container {
            text-align: center;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #aaa;
        }
        th {
            background-color: #ecf0f1;
            color: #2c3e50;
            font-weight: bold;
        }
        details {
            margin-top: 15px;
            padding: 15px;
            background: #f0f3f6;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        summary {
            font-weight: bold;
            cursor: pointer;
            padding: 5px 0;
        }
        code {
            background: #eee;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.95em;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #95a5a6;
            font-size: 0.9em;
        }
        .loading {
            color: #3498db;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
        }
        .train-log-info {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        .card-content {
            line-height: 1.6;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>DPGEN Web Interface</h1>
    <p class="subtitle">Real-time monitoring of DPGEN tasks</p>

    <!-- –í—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ -->
    <div class="section">
        <h2>üìÅ Working Directory</h2>
        <form id="dirForm">
            <input type="text" id="workDir" value="{{ work_dir }}" placeholder="Enter DPGEN working directory">
            <button type="submit">Set Directory</button>
        </form>
        {% if error %}
            <p style="color: red; margin-top: 10px;">‚ùå {{ error }}</p>
        {% endif %}
    </div>



    <!-- –ì—Ä–∞—Ñ–∏–∫ –æ—à–∏–±–∫–∏ –æ–±—É—á–µ–Ω–∏—è -->
    {% if data.loss_data and data.loss_data|length > 0 %}
    <div class="section">
        <h2>üìâ Training Loss (Last 10)</h2>
        <canvas id="lossChart" height="100"></canvas>
    </div>
    {% endif %}

    <!-- –¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ -->
    {% if data.current_hash %}
    <div class="section current-task-section">
        <h2>üöÄ Current Execution</h2>
        <table>
            <tr><th>Field</th><th>Value</th></tr>
            <tr><td><strong>Hash Directory</strong></td><td><code data-field="hash_name">{{ data.current_hash.hash_name }}</code></td></tr>
            <tr><td><strong>Last Modified</strong></td><td data-field="mtime">{{ data.current_hash.mtime }}</td></tr>
            <tr><td><strong>Iteration</strong></td><td data-field="iter">{{ data.current_stage.iter }}</td></tr>
            <tr><td><strong>Stage</strong></td><td data-field="stage_label">{{ data.current_stage.stage_label }}</td></tr>
        </table>

        <!-- –ê–Ω–∞–ª–∏–∑ FP -->
        {% if data.fp_analysis %}
        <div class="fp-analysis-section">
            <h3>üîç FP Tasks Analysis</h3>
            <table>
                <tr><th>Metric</th><th>Value</th></tr>
                <tr><td><strong>Total Tasks</strong></td><td data-fp="total">{{ data.fp_analysis.total }}</td></tr>
                <tr><td><strong>‚úÖ Finished</strong></td><td data-fp="done">{{ data.fp_analysis.done }}</td></tr>
                <tr><td><strong>‚ùå Failed</strong></td><td data-fp="failed">{{ data.fp_analysis.failed | length }}</td></tr>
                <tr><td><strong>‚ö†Ô∏è Running</strong></td><td data-fp="running">{{ data.fp_analysis.running | length }}</td></tr>
                <tr><td><strong>‚è∏Ô∏è Pending</strong></td><td data-fp="pending">{{ data.fp_analysis.pending | length }}</td></tr>
                <tr><td><strong>üîÑ Remaining</strong></td><td data-fp="remaining">{{ data.fp_analysis.remaining }}</td></tr>
            </table>

            {% if data.fp_analysis.has_data %}
            <p><strong>‚è±Ô∏è Average task time:</strong> <span data-fp="avg_duration">{{ data.fp_analysis.avg_duration_str }}</span></p>
            <p><strong>üïí Predicted time for remaining:</strong> <span data-fp="predicted">{{ data.fp_analysis.predicted_remaining_str }}</span></p>
            {% endif %}

            <details>
                <summary>üìã Show task lists</summary>
                <ul style="padding-left: 20px;">
                    <li><strong>‚úÖ Finished ({{ data.fp_analysis.finished | length }}):</strong>
                        <ul>{% for t in data.fp_analysis.finished %}<li><code>{{ t }}</code></li>{% endfor %}</ul>
                    </li>
                    <li><strong>‚ùå Failed ({{ data.fp_analysis.failed | length }}):</strong>
                        <ul>{% for t in data.fp_analysis.failed %}<li><code>{{ t }}</code></li>{% endfor %}</ul>
                    </li>
                    <li><strong>‚ö†Ô∏è Running ({{ data.fp_analysis.running | length }}):</strong>
                        <ul>{% for t in data.fp_analysis.running %}<li><code>{{ t }}</code></li>{% endfor %}</ul>
                    </li>
                    <li><strong>‚è∏Ô∏è Pending ({{ data.fp_analysis.pending | length }}):</strong>
                        <ul>{% for t in data.fp_analysis.pending %}<li><code>{{ t }}</code></li>{% endfor %}</ul>
                    </li>
                </ul>
            </details>
        </div>
        {% endif %}

        <!-- Live Training Plot -->
        {% if data.show_train_plot %}
        <h3>üìâ Live Training Loss (Active: <span id="activeSubdir">{{ data.active_train_subdir }}</span>)</h3>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ train.log -->
        {% if data.train_log_info %}
        <div class="train-log-info">
            <strong>Training Info:</strong><br>
            <span>Step: <strong>{{ data.train_log_info.batch }}</strong></span> | 
            <span>ETA: <strong>{{ data.train_log_info.eta }}</strong></span> | 
            <span>Finish: <strong>{{ data.train_log_info.finish_time }}</strong></span>
        </div>
        {% endif %}

        <img id="trainPlotImg" src="/train_plot" 
             alt="Training Curve" 
             style="max-width: 100%; border: 1px solid #ddd;">
        <p><em>Auto-refresh every 30 seconds</em></p>
        {% endif %}
    </div>
    {% endif %}

    <!-- –ê–Ω–∞–ª–∏–∑ model_devi -->
    {% if data.model_devi_data and data.model_devi_data|length > 0 %}
    <div class="section">
        <h2>üìä Model Deviation Tasks (Individual)</h2>
        <p><strong>Total completed tasks:</strong> {{ data.model_devi_data|length }}</p>

        <table>
            <tr>
                <th>Iteration</th>
                <th>Task</th>
                <th>Temp (K)</th>
                <th>Mean max_devi_f</th>
                <th>Max max_devi_f</th>
                <th>Count</th>
            </tr>
            {% for t in data.model_devi_data %}
            <tr>
                <td><code>{{ t.iter }}</code></td>
                <td><code>{{ t.task }}</code></td>
                <td>{{ t.temperature or 'N/A' }}</td>
                <td>{{ "%.4f"|format(t.mean) }}</td>
                <td>{{ "%.4f"|format(t.max) }}</td>
                <td>{{ t.count }}</td>
            </tr>
            {% endfor %}
        </table>

        <details>
            <summary>üñºÔ∏è Show histograms of max_devi_f</summary>
            {% for t in data.model_devi_data %}
            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #fdfdfd;">
                <h4>{{ t.iter }} / {{ t.task }}</h4>
                {% if t.temperature %}
                <p><strong>Temperature:</strong> {{ t.temperature }} K</p>
                {% endif %}
                <p><strong>Mean:</strong> {{ "%.4f"|format(t.mean) }},
                   <strong>Max:</strong> {{ "%.4f"|format(t.max) }},
                   <strong>N:</strong> {{ t.count }}</p>
                {% if t.histogram_image %}
                <img src="{{ t.histogram_image }}" alt="Histogram" style="max-width: 100%; border: 1px solid #eee;">
                {% endif %}
            </div>
            {% endfor %}
        </details>
    </div>
    {% endif %}

    <!-- –°–ø–∏—Å–æ–∫ –∏—Ç–µ—Ä–∞—Ü–∏–π -->
    {% if data.iterations %}
    <div class="section">
        <h2>üìã Iterations</h2>
        <ul style="font-family: monospace; padding-left: 20px;">
            {% for it in data.iterations %}
            <li><code>{{ it }}</code></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    {% if work_dir %}
    <div class="section">
        <h2>Train History</h2>
        <div class="btn-container">
            <a href="/train_history" target="blank" class="btn-success">üìä View Training History</a>
        </div>
        <p style="text-align: center; color: #7f8c8d; font-size: 0.9em;">
            Browse completed training tasks and their loss curves
        </p>
    </div>
    {% endif %}
    <div class="footer">
        DPGEN Web Monitor 
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('dirForm').onsubmit = function(e) {
    e.preventDefault();
    const dir = document.getElementById('workDir').value.trim();
    if (!dir) return;
    fetch('/set_dir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dir: dir })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(err => {
        alert('Network error: ' + err.message);
    });
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ—Ç–µ—Ä—å
{% if data.loss_data and data.loss_data|length > 0 %}
const ctx = document.getElementById('lossChart').getContext('2d');
window.lossChart = new Chart(ctx, {
    type: 'line',
     {
        labels: Array.from({length: {{ data.loss_data|length }}}, (_, i) => `Step ${i + 1}`),
        datasets: [{
            label: 'Validation Loss',
             {{ data.loss_data | tojson }},
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: { 
        responsive: true,
        maintainAspectRatio: false
    }
});
{% endif %}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏
function updateCurrentTask() {
    const workDirInput = document.getElementById('workDir');
    if (!workDirInput || !workDirInput.value.trim()) {
        return;
    }
    
    fetch('/current_status')
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            console.error('Error fetching current status:', data.error);
            return;
        }
        
        updateCurrentTaskDisplay(data);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Ç–µ—Ä—å –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
        if (data.loss_data && data.loss_data.length > 0) {
            updateLossChart(data.loss_data);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–±—É—á–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (data.show_train_plot) {
            const img = document.querySelector('#trainPlotImg');
            if (img) {
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
                img.src = '/train_plot?t=' + new Date().getTime();
            }
        }
    })
    .catch(error => {
        console.error('Error updating current task:', error);
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏
function updateCurrentTaskDisplay(data) {
    const currentTaskSection = document.querySelector('.current-task-section');
    if (!currentTaskSection) return;
    
    if (data.current_hash) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ö—ç—à–µ
        const hashElements = currentTaskSection.querySelectorAll('[data-field="hash_name"]');
        hashElements.forEach(el => {
            el.textContent = data.current_hash.hash_name || 'N/A';
        });
        
        const mtimeElements = currentTaskSection.querySelectorAll('[data-field="mtime"]');
        mtimeElements.forEach(el => {
            el.textContent = data.current_hash.mtime || 'N/A';
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞–¥–∏–∏
        const iterElements = currentTaskSection.querySelectorAll('[data-field="iter"]');
        iterElements.forEach(el => {
            el.textContent = data.current_stage.iter || 'N/A';
        });
        
        const stageElements = currentTaskSection.querySelectorAll('[data-field="stage_label"]');
        stageElements.forEach(el => {
            el.textContent = data.current_stage.stage_label || 'N/A';
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –æ–±—É—á–µ–Ω–∏—è
        const activeSubdirElement = document.getElementById('activeSubdir');
        if (activeSubdirElement) {
            activeSubdirElement.textContent = data.active_train_subdir || 'N/A';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ train.log
        const trainLogInfoDiv = document.querySelector('.train-log-info');
        if (trainLogInfoDiv && data.train_log_info) {
            trainLogInfoDiv.innerHTML = `
                <strong>Training Info:</strong><br>
                <span>Step: <strong>${data.train_log_info.batch}</strong></span> | 
                <span>ETA: <strong>${data.train_log_info.eta}</strong></span> | 
                <span>Finish: <strong>${data.train_log_info.finish_time}</strong></span>
            `;
            trainLogInfoDiv.style.display = 'block';
        } else if (trainLogInfoDiv) {
            trainLogInfoDiv.style.display = 'none';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º FP –∞–Ω–∞–ª–∏–∑
        if (data.fp_analysis) {
            updateFPAnalysis(data.fp_analysis);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è FP –∞–Ω–∞–ª–∏–∑–∞
function updateFPAnalysis(fpData) {
    const fpSection = document.querySelector('.fp-analysis-section');
    if (!fpSection) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const totalEl = fpSection.querySelector('[data-fp="total"]');
    if (totalEl) totalEl.textContent = fpData.total || 0;
    
    const doneEl = fpSection.querySelector('[data-fp="done"]');
    if (doneEl) doneEl.textContent = fpData.done || 0;
    
    const failedEl = fpSection.querySelector('[data-fp="failed"]');
    if (failedEl) failedEl.textContent = fpData.failed ? fpData.failed.length : 0;
    
    const runningEl = fpSection.querySelector('[data-fp="running"]');
    if (runningEl) runningEl.textContent = fpData.running ? fpData.running.length : 0;
    
    const pendingEl = fpSection.querySelector('[data-fp="pending"]');
    if (pendingEl) pendingEl.textContent = fpData.pending ? fpData.pending.length : 0;
    
    const remainingEl = fpSection.querySelector('[data-fp="remaining"]');
    if (remainingEl) remainingEl.textContent = fpData.remaining || 0;
    
    if (fpData.has_data) {
        const avgDurationEl = fpSection.querySelector('[data-fp="avg_duration"]');
        if (avgDurationEl) avgDurationEl.textContent = fpData.avg_duration_str || 'N/A';
        
        const predictedEl = fpSection.querySelector('[data-fp="predicted"]');
        if (predictedEl) predictedEl.textContent = fpData.predicted_remaining_str || 'N/A';
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ—Ç–µ—Ä—å
function updateLossChart(lossData) {
    const chartElement = document.getElementById('lossChart');
    if (!chartElement || !lossData || lossData.length === 0) return;
    
    // –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
    if (window.lossChart) {
        const chart = window.lossChart;
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏ (–±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–Ω–∞—á–µ–Ω–∏–π)
        const displayData = lossData.slice(-10);
        chart.data.labels = Array.from({length: displayData.length}, (_, i) => `Step ${i + 1}`);
        chart.data.datasets[0].data = displayData;
        chart.update();
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(updateCurrentTask, 30000);

// –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
setTimeout(updateCurrentTask, 5000);

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º)
setInterval(() => {
    console.log("üîÑ Full page refresh...");
    location.reload();
}, 300000);
</script>
</body>
</html>
